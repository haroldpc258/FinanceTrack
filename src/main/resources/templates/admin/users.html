<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>
<body class="bg-gray-50">
    <div th:replace="~{fragments/layout :: sidebar}"></div>
    
    <div class="ml-64 p-8 ">
        <!-- Header principal -->
        <div th:replace="~{fragments/header :: header}"></div>

        <!-- Navigation -->
        <div th:replace="~{fragments/navigation :: navigation}"></div>

        <div class="bg-white rounded-xl shadow-sm p-6">
            <!-- Header de usuarios -->
            <div th:replace="~{fragments/users/header :: users-header}"></div>

            <!-- Barra de búsqueda y filtros -->
            <div th:replace="~{fragments/users/search-bar :: search-bar}"></div>

            <!-- Tabla de usuarios -->
            <div th:replace="~{fragments/users/table :: users-table}"></div>
        </div>
    </div>
    <script th:inline="javascript">
        function toggleDropdown(userId) {
            document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                if (dropdown.id !== `dropdown-${userId}`) {
                    dropdown.classList.add('hidden');
                }
            });

            // Toggle del dropdown actual
            const dropdown = document.getElementById(`dropdown-${userId}`);
            if (dropdown) {
                dropdown.classList.toggle('hidden');

                const closeDropdown = (e) => {
                    if (!e.target.closest(`#dropdown-${userId}`) &&
                        !e.target.closest(`button[onclick*="${userId}"]`)) {
                        dropdown.classList.add('hidden');
                        document.removeEventListener('click', closeDropdown);
                    }
                };

                setTimeout(() => {
                    document.addEventListener('click', closeDropdown);
                }, 100);
            }
        }

        // Función para filtrar la tabla
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const companyFilter = document.getElementById('companyFilter')?.value || '';
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const rows = document.querySelectorAll('tbody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const company = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const role = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                const statusElement = row.querySelector('td:nth-child(5) span');
                const status = statusElement ? statusElement.textContent.trim().toLowerCase() : '';

                // Obtener el ID de la empresa desde el atributo de datos o del enlace
                const companyId = row.getAttribute('data-company-id') ||
                    (row.querySelector('a[href*="/companies/"]')?.getAttribute('href')?.match(/\/companies\/(\d+)\//))?.[1] || '';

                // Aplicar filtros
                const matchesSearch = name.includes(searchTerm) ||
                    email.includes(searchTerm) ||
                    company.includes(searchTerm);

                const matchesCompany = companyFilter === '' || (companyId === companyFilter);

                const matchesRole = roleFilter === '' ||
                    (roleFilter === 'ADMINISTRATOR' && role.includes('administrador')) ||
                    (roleFilter === 'OPERATIVE' && role.includes('operativo'));

                const matchesStatus = statusFilter === '' ||
                    (statusFilter === 'active' && status.includes('activo')) ||
                    (statusFilter === 'suspended' && status.includes('suspendido'));

                // Mostrar u ocultar la fila según los filtros
                if (matchesSearch && matchesCompany && matchesRole && matchesStatus) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            });

            // Actualizar el contador de usuarios
            const countElement = document.getElementById('counter');
            if (countElement) {
                const totalUsers = rows.length;
                countElement.textContent = `Mostrando ${visibleCount} de ${totalUsers} usuarios`;
            }
        }

        function clearFilters() {
            // Limpiar campo de búsqueda
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }

            // Resetear todos los selectores a la opción predeterminada
            const selects = ['companyFilter', 'roleFilter', 'statusFilter'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.value = '';
                }
            });

            // Aplicar los filtros (ahora vacíos) para mostrar todas las filas
            filterTable();
        }

        // Eventos para la búsqueda en tiempo real y filtros
        document.addEventListener('DOMContentLoaded', function() {
            // Guardar valores iniciales para cada fila para mejorar el rendimiento
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                // Extraer ID de empresa de los enlaces si está disponible
                const companyLink = row.querySelector('a[href*="/companies/"]');
                if (companyLink) {
                    const match = companyLink.getAttribute('href').match(/\/companies\/(\d+)\//);
                    if (match && match[1]) {
                        row.setAttribute('data-company-id', match[1]);
                    }
                }
            });

            // Evento para la búsqueda en tiempo real
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterTable);
            }

            // Eventos para los selectores de filtro
            const filters = ['companyFilter', 'roleFilter', 'statusFilter'];
            filters.forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter) {
                    filter.addEventListener('change', filterTable);
                }
            });

            // Evento para el botón limpiar
            const filterButton = document.getElementById('clearFiltersButton');
            if (filterButton) {
                filterButton.addEventListener('click', clearFilters);
            }
        });
    </script>
</body>
</html>